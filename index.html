<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Mur simulateur 2D (par Constr'huy)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      margin: 0; 
      background: #1e1e1e; 
      color: #d4d4d4; 
      font-family: 'Segoe UI', sans-serif; 
    }
    
    /* Boîte d'accueil */
    #welcome-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #2d2d30;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    #welcome-title {
      font-size: 48px;
      font-weight: bold;
      margin-bottom: 10px;
      color: #fff;
    }
    
    #welcome-version {
      font-size: 18px;
      margin-bottom: 30px;
      color: #aaa;
    }
    
    #start-btn {
      padding: 12px 24px;
      background: #B22222;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 18px;
      cursor: pointer;
    }
    
    #start-btn:hover {
      background: #C23535;
    }
    
    /* Interface principale */
    #main-interface {
      display: none;
      width: 100%;
    }
    
    #toolbar { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 60px; 
      background: #2d2d30; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      padding: 10px; 
      height: 100vh; 
      box-sizing: border-box; 
      border-right: 1px solid #3c3c3c; 
      gap: 10px; 
      z-index: 100; 
    }
    
    #toolbar button, #toolbar label { 
      background: #3c3c3c; 
      color: #d4d4d4; 
      border: none; 
      width: 40px; 
      height: 40px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-size: 16px; 
      border-radius: 4px; 
      cursor: pointer; 
    }
    
    #toolbar button:hover, #toolbar label:hover { 
      background: #505050; 
    }
    
    #settings-panel { 
      position: fixed; 
      top: 80px; 
      left: 80px; 
      background: #2d2d30; 
      padding: 15px; 
      border-radius: 5px; 
      border: 1px solid #3c3c3c; 
      z-index: 90; 
      display: none; 
    }
    
    #settings-panel label { 
      display: block; 
      margin: 5px 0; 
    }
    
    #settings-panel input { 
      width: 60px; 
      margin-left: 5px; 
    }
    
    #header { 
      margin-top: 0; 
      padding: 20px 0 10px; 
      text-align: center; 
      width: 100%; 
      font-size: 32px; 
      font-weight: bold; 
      border-bottom: 1px solid #3c3c3c; 
    }
    
    #container { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      width: calc(100% - 60px); 
      padding-left: 60px; 
      box-sizing: border-box; 
    }
    
    .canvas-row { 
      display: flex; 
      justify-content: center; 
      gap: 20px; 
      margin: 20px 0; 
    }
    
    .view { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      position: relative; 
    }
    
    canvas { 
      background: white; 
      border: 1px solid #444; 
    }
    
    .label { 
      margin-top: 4px; 
      text-align: center; 
      font-size: 16px; 
      color: #f0f0f0; 
    }
    
    .legend { 
      font-size: 12px; 
      color: #aaa; 
      margin-top: 2px; 
    }
    
    .layer-controls { 
      display: flex; 
      gap: 10px; 
      align-items: center; 
      margin: 5px 0; 
    }
    
    .layer-selector { 
      padding: 5px; 
      border-radius: 4px; 
      background: #3c3c3c; 
      color: white; 
      border: 1px solid #505050; 
    }
    
    .export-image-btn { 
      position: absolute; 
      top: 5px; 
      right: 5px; 
      background: #3c3c3c; 
      color: white; 
      border: none; 
      width: 30px; 
      height: 30px; 
      border-radius: 4px; 
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .export-image-btn:hover { 
      background: #505050; 
    }
    
    .add-layer-btn { 
      background: #3c3c3c; 
      color: white; 
      border: none; 
      width: 30px; 
      height: 30px; 
      border-radius: 4px; 
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .add-layer-btn:hover { 
      background: #505050; 
    }
    
    .settings-btn {
      position: absolute;
      top: 5px;
      left: 5px;
      background: #3c3c3c;
      color: white;
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .settings-btn:hover { 
      background: #505050; 
    }
  </style>
</head>
<body>
  <!-- Écran d'accueil -->
  <div id="welcome-screen">
    <div id="welcome-title">Mur simulateur 2D</div>
    <div id="welcome-version">Version 2.0</div>
    <button id="start-btn">Commencer</button>
  </div>

  <!-- Interface principale -->
  <div id="main-interface">
    <div id="toolbar">
      <button title="Brique entière" onclick="selectType('entire')" style="background:#B22222">1/1</button>
      <button title="Trois quarts" onclick="selectType('threeQuarters')" style="background:#FF8C00">3/4</button>
      <button title="Demi" onclick="selectType('half')" style="background:#4682B4">1/2</button>
      <button title="Quart" onclick="selectType('quarter')" style="background:#32CD32">1/4</button>
      <button title="Rotation 90°" onclick="rotateBrick()"><i class="fas fa-sync-alt"></i></button>
      <button title="Annuler" onclick="undo()"><i class="fas fa-undo"></i></button>
      <button title="Nouvelle assise" onclick="addLayer()"><i class="fas fa-layer-group"></i></button>
      <button title="Exporter JSON" onclick="exportPose()"><i class="fas fa-file-export"></i></button>
      <button title="Exporter PDF" onclick="exportToPDF()"><i class="fas fa-file-pdf"></i></button>
      <input type="file" id="importPose" style="display:none" onchange="importPose(event)">
      <label for="importPose" title="Importer JSON"><i class="fas fa-folder-open"></i></label>
      <button title="Paramètres" onclick="toggleSettings()"><i class="fas fa-cog"></i></button>
    </div>

    <div id="settings-panel">
      <h3>Paramètres</h3>
      <label>Joint vertical (mm): <input type="number" id="jointWidth" value="10" min="0" max="20" step="1" onchange="updateJointWidth()"></label>
      <label>Largeur brique (cm): <input type="number" id="brickWidth" value="19" min="5" max="30" step="1" onchange="updateBrickDimensions()"></label>
      <label>Hauteur brique (cm): <input type="number" id="brickHeight" value="6.5" min="2" max="15" step="0.5" onchange="updateBrickDimensions()"></label>
      <label>Profondeur brique (cm): <input type="number" id="brickDepth" value="9" min="5" max="20" step="1" onchange="updateBrickDimensions()"></label>
      <label><input type="checkbox" id="fillBricks" checked onchange="updateFillBricks()"> Remplissage des briques</label>
    </div>

    <div id="header">Mur simulateur 2D (par Constr'huy)</div>
    <div id="container">
      <div class="canvas-row">
        <div class="view">
          <canvas id="topView" width="800" height="400"></canvas>
          <div class="label">Vue en plan</div>
          <div class="layer-controls">
            <select id="layerSelect" class="layer-selector" onchange="changeLayer(this.value)">
              <option value="0">Assise 1</option>
            </select>
            <button class="add-layer-btn" onclick="addLayer()" title="Ajouter une assise">
              <i class="fas fa-plus"></i>
            </button>
          </div>
          <div class="legend">
            <span style="color:#B22222">■</span>1/1 | <span style="color:#FF8C00">■</span>3/4 | <span style="color:#4682B4">■</span>1/2 | <span style="color:#32CD32">■</span>1/4
          </div>
          <button class="export-image-btn" onclick="exportCanvasAsImage('topView', 'vue_plan.png')">
            <i class="fas fa-camera"></i>
          </button>
          <button class="settings-btn" onclick="toggleSettings()">
            <i class="fas fa-cog"></i>
          </button>
        </div>
      </div>
      <div class="canvas-row">
        <div class="view">
          <canvas id="frontView" width="800" height="400"></canvas>
          <div class="label">Vue de face</div>
          <button class="export-image-btn" onclick="exportCanvasAsImage('frontView', 'vue_face.png')">
            <i class="fas fa-camera"></i>
          </button>
        </div>
      </div>
      <div class="canvas-row">
        <div class="view">
          <canvas id="leftView" width="400" height="400"></canvas>
          <div class="label">Vue gauche</div>
          <button class="export-image-btn" onclick="exportCanvasAsImage('leftView', 'vue_gauche.png')">
            <i class="fas fa-camera"></i>
          </button>
        </div>
        <div class="view">
          <canvas id="rightView" width="400" height="400"></canvas>
          <div class="label">Vue droite</div>
          <button class="export-image-btn" onclick="exportCanvasAsImage('rightView', 'vue_droite.png')">
            <i class="fas fa-camera"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Configuration initiale
    const brickTypes = {
      entire: { color: '#B22222' },
      threeQuarters: { color: '#FF8C00' },
      half: { color: '#4682B4' },
      quarter: { color: '#32CD32' }
    };
    
    let brickDimensions = {
      entire: { w: 19, h: 6.5, d: 9 },
      threeQuarters: { w: 14, h: 6.5, d: 9 },
      half: { w: 9, h: 6.5, d: 9 },
      quarter: { w: 4, h: 6.5, d: 9 }
    };
    
    let scale = 5;
    let gridSize = scale;
    let jointWidth = 10; // en mm
    let layers = [[]];
    let currentLayer = 0;
    let ghostBrick = null;
    let selectedBrickType = 'entire';
    let rotation = 0;
    let fillBricks = true;
    const groundOffset = 15 * scale; // 15cm en pixels
    
    // Éléments DOM
    const welcomeScreen = document.getElementById('welcome-screen');
    const mainInterface = document.getElementById('main-interface');
    const startBtn = document.getElementById('start-btn');
    const topCanvas = document.getElementById('topView');
    const frontCanvas = document.getElementById('frontView');
    const leftCanvas = document.getElementById('leftView');
    const rightCanvas = document.getElementById('rightView');
    const layerSelect = document.getElementById('layerSelect');
    const settingsPanel = document.getElementById('settings-panel');
    
    const ctxs = {
      top: topCanvas.getContext('2d'),
      front: frontCanvas.getContext('2d'),
      left: leftCanvas.getContext('2d'),
      right: rightCanvas.getContext('2d')
    };

    // Écran d'accueil
    startBtn.addEventListener('click', () => {
      welcomeScreen.style.display = 'none';
      mainInterface.style.display = 'block';
      drawAll();
    });

    function toggleSettings() {
      settingsPanel.style.display = settingsPanel.style.display === 'block' ? 'none' : 'block';
    }

    function updateJointWidth() {
      jointWidth = parseInt(document.getElementById('jointWidth').value);
      drawAll();
    }

    function updateBrickDimensions() {
      const w = parseFloat(document.getElementById('brickWidth').value);
      const h = parseFloat(document.getElementById('brickHeight').value);
      const d = parseFloat(document.getElementById('brickDepth').value);
      
      brickDimensions = {
        entire: { w, h, d },
        threeQuarters: { w: w*0.75, h, d },
        half: { w: w*0.5, h, d },
        quarter: { w: w*0.25, h, d }
      };
      
      drawAll();
    }

    function updateFillBricks() {
      fillBricks = document.getElementById('fillBricks').checked;
      drawAll();
    }

    function updateLayerSelect() {
      layerSelect.innerHTML = '';
      layers.forEach((layer, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = `Assise ${index + 1}`;
        option.selected = index === currentLayer;
        layerSelect.appendChild(option);
      });
    }

    function changeLayer(index) {
      currentLayer = parseInt(index);
      drawAll();
    }

    function selectType(type) { 
      selectedBrickType = type; 
      drawAll(); 
    }
    
    function importPose(e) { 
      const reader = new FileReader(); 
      reader.onload = ev => { 
        layers = JSON.parse(ev.target.result); 
        currentLayer = layers.length - 1; 
        updateLayerSelect();
        drawAll(); 
      }; 
      reader.readAsText(e.target.files[0]); 
    }

    function getBrickSize(type = selectedBrickType, rot = rotation) { 
      const { w, h, d } = brickDimensions[type]; 
      const color = brickTypes[type].color;
      return rot % 180 === 0 ? { w, h, d, color } : { w: d, h, d: w, color }; 
    }

    function drawGrid(ctx, w, h) { 
      ctx.clearRect(0,0,w,h); 
      ctx.beginPath(); 
      for(let x=0;x<=w;x+=gridSize){ ctx.moveTo(x,0); ctx.lineTo(x,h); } 
      for(let y=0;y<=h;y+=gridSize){ ctx.moveTo(0,y); ctx.lineTo(w,y); } 
      ctx.strokeStyle='#ddd'; 
      ctx.stroke(); 
    }

    function drawGround(ctx, w) {
      ctx.beginPath();
      ctx.moveTo(0, ctx.canvas.height - groundOffset);
      ctx.lineTo(w, ctx.canvas.height - groundOffset);
      ctx.lineWidth = 3;
      ctx.strokeStyle = '#000';
      ctx.stroke();
      ctx.lineWidth = 1;
    }

    function drawTopView() { 
      const ctx = ctxs.top;
      drawGrid(ctx, topCanvas.width, topCanvas.height); 
      
      layers.forEach(layer => layer.forEach(b => { 
        if (fillBricks) {
          ctx.fillStyle = b.color; 
          ctx.fillRect(b.x, b.y, b.w, b.h);
        } else {
          ctx.strokeStyle = b.color;
          ctx.strokeRect(b.x, b.y, b.w, b.h);
        }
        
        // Dessin des trous (blancs)
        const holeRadius = 2 * scale;
        let holes = b.type==='entire'?3:b.type==='threeQuarters'?2:b.type==='half'?1:0;
        
        if(holes>0){
          const rot = b.rotation%180;
          if(rot===0){
            const spacing = (b.w - holes*holeRadius*2)/(holes+1);
            const centerY = b.y + b.h/2;
            let positions = [];
            
            if(b.type==='threeQuarters'){
              const entireSpacing = (brickDimensions.entire.w*scale - 6*holeRadius)/4;
              positions = [
                b.x + entireSpacing + holeRadius, 
                b.x + entireSpacing*2 + holeRadius*3
              ];
            } else {
              for(let i=0;i<holes;i++){
                positions.push(b.x + spacing*(i+1) + holeRadius*(2*i+1));
              }
            }
            
            positions.forEach(cx => {
              ctx.beginPath();
              ctx.arc(cx, centerY, holeRadius, 0, 2*Math.PI);
              ctx.fillStyle='white';
              ctx.fill();
              ctx.strokeStyle='black';
              ctx.stroke();
            });
          } else {
            const spacingV = (b.h - holes*holeRadius*2)/(holes+1);
            const centerX = b.x + b.w/2;
            let positions = [];
            
            for(let i=0;i<holes;i++){
              positions.push(b.y + spacingV*(i+1) + holeRadius*(2*i+1));
            }
            
            positions.forEach(cy => {
              ctx.beginPath();
              ctx.arc(centerX, cy, holeRadius, 0, 2*Math.PI);
              ctx.fillStyle='white';
              ctx.fill();
              ctx.strokeStyle='black';
              ctx.stroke();
            });
          }
        }
      })); 
      
      if(ghostBrick){ 
        const s = getBrickSize(); 
        ctx.fillStyle = '#00000033'; 
        ctx.fillRect(ghostBrick.x, ghostBrick.y, s.w*scale, s.d*scale); 
      } 
    }

    function drawView(ctx, mode) { 
      drawGrid(ctx, ctx.canvas.width, ctx.canvas.height); 
      drawGround(ctx, ctx.canvas.width);
      
      const lh = (brickDimensions.entire.h*scale) + (jointWidth * scale / 10);
      
      // Dessiner les graduations d'assises
      ctx.font = '10px Arial';
      ctx.fillStyle = 'black';
      ctx.textAlign = 'right';
      
      layers.forEach((layer, z) => {
        const yPos = ctx.canvas.height - groundOffset - (z * lh);
        
        // Graduation
        ctx.beginPath();
        ctx.moveTo(ctx.canvas.width - 30, yPos);
        ctx.lineTo(ctx.canvas.width - 25, yPos);
        ctx.stroke();
        ctx.fillText(`A${z+1}`, ctx.canvas.width - 35, yPos + 3);
      });
      
      // Dessiner les briques
      layers.forEach((layer, z) => {
        layer.forEach(b => {
          const bs = getBrickSize(b.type, b.rotation);
          const yPos = ctx.canvas.height - groundOffset - (z * lh) - bs.h*scale;
          
          if (fillBricks) {
            ctx.fillStyle = b.color;
            if (mode === 'front') {
              ctx.fillRect(b.x, yPos, b.w, bs.h*scale);
            } else {
              ctx.fillRect(b.y, yPos, b.h, bs.h*scale);
            }
          } else {
            ctx.strokeStyle = b.color;
            if (mode === 'front') {
              ctx.strokeRect(b.x, yPos, b.w, bs.h*scale);
            } else {
              ctx.strokeRect(b.y, yPos, b.h, bs.h*scale);
            }
          }
        });
      });
    }

    function drawAll() { 
      drawTopView(); 
      drawView(ctxs.front, 'front'); 
      drawView(ctxs.left, 'left'); 
      drawView(ctxs.right, 'right'); 
    }

    topCanvas.addEventListener('mousemove', e => { 
      const r = topCanvas.getBoundingClientRect(); 
      ghostBrick = { 
        x: Math.floor((e.clientX-r.left)/gridSize)*gridSize, 
        y: Math.floor((e.clientY-r.top)/gridSize)*gridSize 
      }; 
      drawAll(); 
    });

    topCanvas.addEventListener('click', () => { 
      const s = getBrickSize(); 
      layers[currentLayer].push({ 
        x: ghostBrick.x, 
        y: ghostBrick.y, 
        w: s.w*scale, 
        h: s.d*scale, 
        color: s.color, 
        rotation, 
        type: selectedBrickType 
      }); 
      drawAll(); 
    });

    function rotateBrick(){ rotation = (rotation + 90) % 360; drawAll(); }
    
    function undo(){ 
      if(layers[currentLayer].length > 0) {
        layers[currentLayer].pop(); 
        drawAll(); 
      }
    }
    
    function addLayer(){ 
      layers.push([]); 
      currentLayer = layers.length - 1; 
      updateLayerSelect();
      drawAll(); 
    }
    
    function exportPose(){ 
      const a = document.createElement('a'), 
            d = JSON.stringify(layers); 
      a.href = 'data:text/json,' + encodeURIComponent(d); 
      a.download = 'pose.json'; 
      a.click(); 
    }

    function exportCanvasAsImage(canvasId, filename) {
      const canvas = document.getElementById(canvasId);
      const tempCanvas = document.createElement('canvas');
      const tempCtx = tempCanvas.getContext('2d');
      
      // Dimensions pour l'export (avec marge pour le titre et l'échelle)
      const exportWidth = canvas.width;
      const exportHeight = canvas.height + 50; // +50px pour le titre et l'échelle
      
      tempCanvas.width = exportWidth;
      tempCanvas.height = exportHeight;
      
      // Fond blanc
      tempCtx.fillStyle = 'white';
      tempCtx.fillRect(0, 0, exportWidth, exportHeight);
      
      // Titre
      tempCtx.fillStyle = 'black';
      tempCtx.font = 'bold 16px Arial';
      tempCtx.textAlign = 'center';
      tempCtx.fillText(document.querySelector(`#${canvasId} + .label`).textContent, exportWidth/2, 20);
      
      // Copie du contenu du canvas original
      tempCtx.drawImage(canvas, 0, 30);
      
      // Ajout de l'échelle
      const scaleLength = 100; // 100px = 20cm (car scale=5)
      tempCtx.fillStyle = 'black';
      tempCtx.fillRect(30, exportHeight - 20, scaleLength, 2);
      tempCtx.fillRect(30, exportHeight - 25, 2, 10);
      tempCtx.fillRect(30 + scaleLength - 2, exportHeight - 25, 2, 10);
      tempCtx.font = '12px Arial';
      tempCtx.fillText('20 cm', 30 + scaleLength/2 - 20, exportHeight - 5);
      
      // Export
      const dataURL = tempCanvas.toDataURL('image/png');
      const link = document.createElement('a');
      link.href = dataURL;
      link.download = filename;
      link.click();
    }

    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: 'a4'
      });
      
      // Taille A4 en mm (210 x 297)
      const a4Width = 210;
      const a4Height = 297;
      const margin = 15;
      
      // Calcul des dimensions pour les vues
      const viewWidth = (a4Width - 3*margin) / 2;
      const viewHeightTop = 80;
      const viewHeightFront = 80;
      const viewHeightSide = 60;
      
      // Fonction pour créer une image haute résolution
      const createHiResImage = (canvasId, width, height) => {
        const canvas = document.getElementById(canvasId);
        const tempCanvas = document.createElement('canvas');
        const tempCtx = tempCanvas.getContext('2d');
        
        // Multiplier la résolution
        const scaleFactor = 2;
        tempCanvas.width = width * scaleFactor;
        tempCanvas.height = height * scaleFactor;
        
        // Fond blanc
        tempCtx.fillStyle = 'white';
        tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
        
        // Dessiner le contenu avec mise à l'échelle
        tempCtx.scale(scaleFactor, scaleFactor);
        tempCtx.drawImage(canvas, 0, 0, width, height);
        
        return tempCanvas.toDataURL('image/jpeg', 0.9);
      };
      
      // Ajouter le titre
      doc.setFontSize(16);
      doc.text('Plan de pose - Mur simulateur 2D', a4Width/2, 20, { align: 'center' });
      
      // Vue en plan (top)
      const topImgData = createHiResImage('topView', 800, 400);
      doc.addImage(topImgData, 'JPEG', margin, 30, a4Width - 2*margin, viewHeightTop);
      
      // Vue de face (front)
      const frontImgData = createHiResImage('frontView', 800, 400);
      doc.addImage(frontImgData, 'JPEG', margin, 30 + viewHeightTop + 10, a4Width - 2*margin, viewHeightFront);
      
      // Vue gauche
      const leftImgData = createHiResImage('leftView', 400, 400);
      doc.addImage(leftImgData, 'JPEG', margin, 30 + viewHeightTop + viewHeightFront + 20, viewWidth, viewHeightSide);
      
      // Vue droite
      const rightImgData = createHiResImage('rightView', 400, 400);
      doc.addImage(rightImgData, 'JPEG', margin*2 + viewWidth, 30 + viewHeightTop + viewHeightFront + 20, viewWidth, viewHeightSide);
      
      // Pied de page
      doc.setFontSize(10);
      doc.text('Généré avec Mur simulateur 2D - Constr\'huy', a4Width/2, a4Height - 10, { align: 'center' });
      
      // Sauvegarder le PDF
      doc.save('plan_de_pose.pdf');
    }

    // Initialisation
    document.getElementById('jointWidth').value = jointWidth;
    document.getElementById('brickWidth').value = brickDimensions.entire.w;
    document.getElementById('brickHeight').value = brickDimensions.entire.h;
    document.getElementById('brickDepth').value = brickDimensions.entire.d;
    document.getElementById('fillBricks').checked = fillBricks;
  </script>
</body>
</html>
